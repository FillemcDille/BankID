@page "/createaccount"
@inject IAccountService AccountService
@using System.ComponentModel.DataAnnotations

<!--Create account form-->
<EditForm Model="_formModel" OnValidSubmit="CreateAccountAsync" FormName="CreateAccountForm">
    <DataAnnotationsValidator />
    
    <div class="d-flex justify-content-center align-items-center flex-column mt-5 mb-4;">
        <h3>Create account</h3>

        <!--Account name-->
        <div class="mb-3">
            <label for=accountName>Account Name</label><br />
            <InputText id="accountName" @bind-Value="_formModel.Name" class="form-control" autocomplete="name" />
            <ValidationMessage For="@(() => _formModel.Name)" />
        </div>

        <!--Account type-->
        <div class="mb-3">
            <label for=accountType>Account Type</label><br />
            <InputSelect id="accountType" @bind-Value="_formModel.Type" class="form-select">
                <option value="">Select account!</option>
                <option value="@AccountType.Deposit">Basic account</option>
                <option value="@AccountType.Savings">Savings account</option>
            </InputSelect>
            <ValidationMessage For="@(() => _formModel.Type)" />
        </div>

        <!--Currency-->
        <div class="mb-3">
            <label for="currency">Currency</label><br />
            <InputSelect id="currency" @bind-Value="_formModel.Currency" class="form-select">
                @foreach (var currency in Enum.GetValues<Currency>())
                {
                    <option value="@currency">@currency</option>
                }
            </InputSelect>
            <ValidationMessage For="@(() => _formModel.Currency)" />
        </div>

        <!--Opening balance-->
        <div class="mb-3">
            <label for="initialBalance">Opening balance</label><br />
            <InputNumber id="initialBalance" @bind-Value="_formModel.InitialBalance" class="form-control" />
            <ValidationMessage For="@(() => _formModel.InitialBalance)" />
        </div>

        <!-- Show interest rate field only if the selected type is 'Savings' -->
        @if (_formModel.Type == AccountType.Savings)
        {
            <div class="mb-3">
                <label for="interestRate">Interest rate (%)</label><br />
                <InputNumber id="interestRate" @bind-Value="_formModel.InterestRatePercent" class="form-control" autocomplete="off" />
                <ValidationMessage For="@(() => _formModel.InterestRatePercent)" />
            </div>
        }

        <button type="submit" class="btn btn-success">Create</button>
    </div>
</EditForm>

<!--List of all accounts-->
<hr class="my-5" />
<h4 class="text-center">All accounts</h4>
@if (_accounts.Count == 0)
{
    <p>There are no accounts yet, register your first account!</p>
}
else
{
    <div class="row justify-content-center">
        @foreach (var account in _accounts)
        {
            
            @if (_isUpdating)
            {
                <div class="text-center text-secondary mb-2">
                    <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                    Auto-updating balances...
                </div>
            }
            <div class="card m-2 shadow-sm" style="width: 20rem;">
                <div class="card-body">
                    <h5 class="card-title">@account.Name</h5>
                    <h6 class="card-subtitle mb-2 text-muted">@account.AccountType</h6>
                    <p class="card-text">
                        Balance: @($"{account.Balance:N2} {account.Currency}")<br />
                        @if (account.AccountType == AccountType.Savings && account.InterestRate is { } r)
                        {
                            <span>Interest: @((r * 100m).ToString("0.##")) %</span><br />
                        }
                        <small class="text-muted">Updated @account.LastUpdated.ToLocalTime()</small>
                    </p>
                    
                    @if (account.AccountType == AccountType.Savings)
                    {
                        <div class="d-flex align-items-center gap-2 my-1">
                            <span>Interest: @(account.InterestRate.HasValue ? (account.InterestRate.Value * 100m).ToString("0.##") + " %" : "-")</span>
                            <button class="btn btn-outline-primary btn-sm"
                                    @onclick="() => ApplyInterestAsync(account.Id)">
                                Apply interest
                            </button>
                        </div>
                        <br />
                    }
                </div>
                
            </div>
        }
    </div>
}

<!--Code for the deisgn -->
@code {

    // Form model class
    public class CreateAccountFormModel
    {
        [Required(ErrorMessage = "Account name is mandatory")]
        [RegularExpression("^[a-zA-Z ]+$", ErrorMessage = "Account name can only contain letters and spaces.")]
        public string Name { get; set; } = string.Empty;
        public AccountType Type { get; set; }
        public Currency Currency { get; set; }
        [Range(0, double.MaxValue, ErrorMessage = "Opening balance cannot be negative.")]
        public decimal InitialBalance { get; set; }
        [Range(0.01, 100.0, ErrorMessage = "Rate must be between 0.01 and 100.")]
        public decimal? InterestRatePercent { get; set; }
    }

    /// <summary>
    /// Model bound to the account creation form
    /// </summary>
    private CreateAccountFormModel _formModel = new();

    private bool _isUpdating = false;


    /// <summary>
    /// Local cache of all existing accounts retrieved from AccountService
    /// </summary>
    private List<BankAccount> _accounts = new();

    /// <summary>
    /// Runs when the component loads, fetches all accounts
    /// </summary>
    /// <returns></returns>
    protected override async Task OnInitializedAsync()
    {
        await AccountService.EnsureLoadedAsync();
        _accounts =  AccountService.GetAccounts().ToList();

        AccountService.StatehasChanged += StateChanged;
        AccountService.AutoApplyInterest();
    }
    public void StateChanged()
    {
        InvokeAsync(async () =>
    {
        _isUpdating = true;
        StateHasChanged();

        await Task.Delay(1000);

        _accounts = AccountService.GetAccounts().ToList();
        _isUpdating = false;
        StateHasChanged();
    });
    }


    /// <summary>
    /// Method that runs when the form is valid and submitted
    /// </summary>
    /// <returns></returns>
    private async Task CreateAccountAsync()
    {
        try
        {
            decimal? rateFraction = null;
            if (_formModel.Type == AccountType.Savings && _formModel.InterestRatePercent is { } p)
                rateFraction = p / 100m;

            var created = await AccountService.CreateAccount(
                _formModel.Name,
                _formModel.Type,
                _formModel.Currency,
                _formModel.InitialBalance,
                rateFraction
            );

            _accounts = AccountService.GetAccounts().ToList();
            // Reset form
            _formModel = new CreateAccountFormModel();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine(ex);
        }
    }

    /// <summary>
    /// Applies interest to a specific savings account and refreshes the UI.
    /// Triggered by the "Apply interest" button.
    /// </summary>
    private async Task ApplyInterestAsync(Guid accountId)
    {
        var credited = await AccountService.ApplyInterestAsync(accountId); // credited amount (SEK)
        _accounts = AccountService.GetAccounts().ToList(); // refresh UI
        StateHasChanged();
    }
}